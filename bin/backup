#!/usr/bin/env bash

source "$HOME"/bin/script.sh

hostname=$(hostname)
vault_volume="/Volumes/vault/"
critical_volume="/Volumes/misc/"
critical_directories=($HOME/Desktop/ $HOME/critical/ $HOME/src/ $HOME/web/ $HOME/.ssh/ $HOME/my-music/ $HOME/writing/)
stampfile="backup-date.txt"

cleanup() {
  exit $?
}

synchronize() {
  rsync -av --delete --ignore-errors "$@" || true
}

function vault {
  test -d "$vault_volume"
  synchronize "$HOME/" "$vault_volume/$hostname"
  udate > "$vault_volume/$stampfile"
  diskutil eject "$vault_volume"
}

function critical {
  test -d "$critical_volume"
  for critical in ${critical_directories[@]}; do
    echo "doing $critical"
    synchronize "$critical" "$critical_volume/$hostname/$critical"
  done
  udate > "$critical_volume/$stampfile"
  diskutil eject "$critical_volume"
}

for argument in $@; do
  case "$argument" in
    vault)
      vault ;;
    critical)
      critical ;;
    *)
      echo "There is no such function $argument" > /dev/stderr
      exit 1 ;;
  esac
done
